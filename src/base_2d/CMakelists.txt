cmake_minimum_required(VERSION 3.10)
project(neptune2dEngine VERSION 1.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall")

set(LIBRARY_NAME neptuneSource)
set(SOURCES
    game.cc
    helper.cc
    gameLoaderHelper.cc
    objects.cc
    pugixml.cc
    imgui/imgui_draw.cc
    imgui/imgui_impl_sdl2.cc
    imgui/imgui_impl_sdl2renderer2.cc
    imgui/imgui_tables.cc
    imgui/imgui_widgets.cc
    imgui/imgui.cc
    imgui/imgui_demo.cc
)


if(APPLE)
    enable_language(OBJC OBJCXX)
    list(REMOVE_ITEM CMAKE_OBJC_FLAGS
        "-std=c++17"
    )
    list(APPEND SOURCES os/macos/platform.mm)
endif()

if(WIN32)
    list(APPEND SOURCES os/windows/platform.cc)
endif()

add_library(${LIBRARY_NAME} SHARED ${SOURCES})

add_subdirectory(libs/SDL2)
add_subdirectory(libs/SDL2_image)
add_subdirectory(libs/SDL2_mixer)
add_subdirectory(libs/SDL2_ttf)
add_subdirectory(libs/libzip)
add_subdirectory(libs/Lua)

target_link_libraries(${LIBRARY_NAME} PRIVATE
    SDL2::SDL2
    SDL2_image::SDL2_image
    SDL2_mixer::SDL2_mixer
    SDL2_ttf::SDL2_ttf
    libzip::zip
    lua_static
)

if (APPLE)
    target_link_libraries(${LIBRARY_NAME} PRIVATE
        "-framework AppKit"
        "-framework Foundation"
    )
endif()

target_include_directories(${LIBRARY_NAME} PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_image/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_mixer/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_ttf/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/libzip/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/Lua/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

target_include_directories(${LIBRARY_NAME} 
    PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}
)

set_target_properties(${LIBRARY_NAME} PROPERTIES
    OUTPUT_NAME "${LIBRARY_NAME}"
)

add_executable(test_example_1 test.cc)
target_link_libraries(test_example_1 PRIVATE
    SDL2::SDL2
    SDL2_image::SDL2_image
    SDL2_mixer::SDL2_mixer
    SDL2_ttf::SDL2_ttf
    libzip::zip
    lua_static
    ${LIBRARY_NAME}
)

target_compile_definitions(test_example_1 PRIVATE
    NEPTUNE_DEBUG_IMGUI
    NEPTUNE_DEBUG_GLOBAL
    NEPTUNE_RESIZEABLE
)

target_include_directories(test_example_1 PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_image/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_mixer/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/SDL2_ttf/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/libzip/include
    ${CMAKE_CURRENT_SOURCE_DIR}/libs/Lua/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)


if (LINUX)
    target_link_options(test_example_1 PRIVATE "-Wl,-rpath,'$ORIGIN'")
endif()

if (APPLE)
    target_link_libraries(test_example_1 PRIVATE
            "-framework AppKit"
            "-framework Foundation"
        )
    add_custom_command(TARGET test_example_1 POST_BUILD
        COMMAND install_name_tool -change @rpath/libneptuneSource.dylib @executable_path/libneptuneSource.dylib
        "${CMAKE_BINARY_DIR}/test_example_1"
    )
endif()

if (WIN32)
    target_link_libraries(test_example_1 PRIVATE gdi32)
endif()